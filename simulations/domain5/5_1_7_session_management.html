<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSSLP Domain 5: Session Management Lab</title>
    <style>
        :root {
            --bg-dark: #0f172a;
            --panel-bg: #1e293b;
            --sess-orange: #f97316;
            --attack-red: #ef4444;
            --safe-green: #22c55e;
            --text: #f1f5f9;
            --border: #334155;
        }
        body {
            font-family: 'Segoe UI', monospace;
            background-color: var(--bg-dark);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        header {
            background: #000;
            width: 100%;
            padding: 15px 0;
            text-align: center;
            border-bottom: 3px solid var(--sess-orange);
            margin-bottom: 20px;
        }
        h1 { margin: 0; font-size: 1.5rem; color: var(--sess-orange); }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 95%;
            max-width: 1400px;
            height: 700px;
        }

        /* BROWSER (VICTIM) */
        .browser-window {
            background: #fff;
            color: #000;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .browser-header {
            background: #e2e8f0;
            padding: 10px;
            border-bottom: 1px solid #cbd5e1;
            font-size: 0.8rem;
            color: #64748b;
            display: flex;
            align-items: center;
        }
        .url-bar {
            background: #fff;
            padding: 5px 10px;
            border-radius: 15px;
            width: 70%;
            margin-left: 10px;
            border: 1px solid #cbd5e1;
            font-family: monospace;
        }
        
        .page-content {
            padding: 30px;
            text-align: center;
            flex-grow: 1;
        }

        .login-form {
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 8px;
            width: 60%;
            margin: 0 auto;
            background: #f8fafc;
        }
        input { padding: 8px; width: 80%; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .btn-login { padding: 10px 20px; background: var(--sess-orange); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-login:hover { filter: brightness(1.1); }

        /* ATTACKER CONSOLE */
        .hacker-console {
            background: #000;
            border: 2px solid var(--attack-red);
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            color: var(--attack-red);
            display: flex;
            flex-direction: column;
        }
        .console-title { border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; font-weight: bold; }
        
        .stolen-data {
            background: #111;
            border: 1px dashed #555;
            padding: 10px;
            margin-bottom: 15px;
            color: #ccc;
            min-height: 50px;
        }

        /* SERVER (BACKEND) */
        .server-panel {
            background: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            grid-column: span 2;
            display: flex;
            justify-content: space-between;
        }
        .session-store {
            background: #000;
            width: 60%;
            border: 1px solid #333;
            padding: 10px;
            font-family: monospace;
            color: #8b949e;
            overflow-y: auto;
            max-height: 150px;
        }
        .config-area {
            width: 35%;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Toggles */
        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #0f172a;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #333;
        }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--safe-green); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Cookie Visual */
        .cookie-badge {
            background: #facc15;
            color: black;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            display: inline-block;
            margin-top: 5px;
        }

        button.action-btn {
            padding: 8px;
            background: #334155;
            border: 1px solid #555;
            color: #ccc;
            border-radius: 4px;
            cursor: pointer;
        }
        button.action-btn:hover { background: #475569; }

    </style>
</head>
<body>

<header>
    <h1>Secure Session Management Lab</h1>
    <p>Session Fixation, Regeneration & HttpOnly Protection</p>
</header>

<div class="dashboard">

    <!-- VICTIM BROWSER -->
    <div class="browser-window">
        <div class="browser-header">
            <span>ðŸ‘¤ Victim's Browser</span>
            <div class="url-box" id="url-bar">https://bank.com/login</div>
        </div>
        <div class="page-content" id="page-body">
            <!-- Login Form -->
            <div class="login-form">
                <h3>Login</h3>
                <input type="text" value="alice" readonly><br>
                <input type="password" value="password"><br>
                <button class="btn-login" onclick="login()">Sign In</button>
            </div>
            <div id="current-cookie" style="margin-top:20px; color:#666; font-size:0.8rem;">
                Current Cookie: <span id="cookie-val" class="cookie-badge">NONE</span>
            </div>
        </div>
    </div>

    <!-- ATTACKER CONSOLE -->
    <div class="hacker-console">
        <div class="console-title">ðŸ’€ Attacker Terminal</div>
        
        <div style="margin-bottom:10px;">
            <button class="action-btn" style="border-color:var(--attack-red); color:var(--attack-red);" onclick="fixateSession()">1. Launch Fixation Attack</button>
            <div style="font-size:0.7rem; color:#666;">Injects SID=666 into Victim's browser.</div>
        </div>

        <div style="margin-bottom:10px;">
            <button class="action-btn" style="border-color:#facc15; color:#facc15;" onclick="stealCookie()">2. Steal Cookie (XSS)</button>
            <div style="font-size:0.7rem; color:#666;">Tries document.cookie via script.</div>
        </div>

        <div>
            <button class="action-btn" onclick="checkAccess()">3. Check Access</button>
            <div style="font-size:0.7rem; color:#666;">Uses SID=666 to hijack account.</div>
        </div>

        <div style="margin-top:20px;">STOLEN SESSION:</div>
        <div class="stolen-data" id="stolen-sid">-- Waiting --</div>
        <div id="hack-result" style="font-weight:bold;"></div>
    </div>

    <!-- SERVER / CONFIG -->
    <div class="server-panel">
        <div class="session-store">
            <strong>ACTIVE SESSIONS (Backend Memory)</strong>
            <hr style="border-color:#333;">
            <div id="session-list">
                <!-- Sessions go here -->
            </div>
        </div>

        <div class="config-area">
            <strong>Security Controls</strong>
            
            <div class="toggle-row">
                <div>
                    <div>Session Regeneration</div>
                    <div style="font-size:0.7rem; color:#aaa;">New ID on Login</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="cfg-regen">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="toggle-row">
                <div>
                    <div>HttpOnly Flag</div>
                    <div style="font-size:0.7rem; color:#aaa;">Block JS Access</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="cfg-http">
                    <span class="slider"></span>
                </label>
            </div>

            <button class="action-btn" onclick="resetLab()">Reset Simulation</button>
        </div>
    </div>

</div>

<script>
    let browserCookie = null;
    let serverSessions = {}; // { 'sid': { user: 'alice', active: true } }
    let attackerSid = "666"; // The fixated ID

    function updateUI() {
        // Update Browser Cookie Display
        const disp = document.getElementById('cookie-val');
        if (disp) {
            const httpOnly = document.getElementById('cfg-http').checked;
            if (browserCookie) {
                disp.innerHTML = `JSESSIONID=${browserCookie}${httpOnly ? ' ðŸ”’(HttpOnly)' : ''}`;
            } else {
                disp.innerText = "NONE";
            }
        }

        // Update Server List
        const list = document.getElementById('session-list');
        list.innerHTML = "";
        for (const [sid, data] of Object.entries(serverSessions)) {
            list.innerHTML += `
                <div style="margin-bottom:5px;">
                    <span style="color:var(--sess-orange)">${sid}</span> : 
                    User=[${data.user || 'Guest'}] 
                    Auth=[${data.auth ? 'YES' : 'NO'}]
                </div>
            `;
        }
    }

    // 1. ATTACKER: FIXATION
    function fixateSession() {
        // Attacker forces the browser to use a known ID
        browserCookie = attackerSid;
        
        // Attacker creates this session on server (e.g. by visiting the site first)
        serverSessions[attackerSid] = { user: null, auth: false };
        
        updateUI();
        alert("Attacker: I have injected JSESSIONID=666 into the victim's browser!");
    }

    // 2. VICTIM: LOGIN
    function login() {
        const regen = document.getElementById('cfg-regen').checked;
        const httpOnly = document.getElementById('cfg-http').checked;

        // If no session exists, create one (normal behavior)
        if (!browserCookie) {
            browserCookie = Math.floor(Math.random() * 10000).toString();
            serverSessions[browserCookie] = { user: null, auth: false };
        }

        let currentSid = browserCookie;

        // AUTHENTICATION LOGIC
        if (regen) {
            // SECURE: Generate NEW ID, Copy Data, Invalidate Old
            const newSid = Math.floor(Math.random() * 10000).toString();
            delete serverSessions[currentSid]; // Destroy old
            serverSessions[newSid] = { user: 'alice', auth: true }; // Create new
            browserCookie = newSid;
            
            updateUI(); // Update UI with new cookie
            
            alert("Server: Login Successful. Session Regenerated (Old ID destroyed).");
        } else {
            // INSECURE: Reuse existing ID (Fixation Vulnerability)
            serverSessions[currentSid].user = 'alice';
            serverSessions[currentSid].auth = true;
            
            updateUI(); // Update UI with updated auth state
            
            alert("Server: Login Successful. Using existing Session ID.");
        }

        // Show Dashboard
        document.getElementById('page-body').innerHTML = `
            <h2>Welcome, Alice!</h2>
            <p>Account Balance: $1,000,000</p>
            <div style="margin-top:20px; color:#666; font-size:0.8rem;">
                Current Cookie: <span id="cookie-val" class="cookie-badge"></span>
            </div>
        `;
        updateUI();
    }

    // 3. ATTACKER: STEAL COOKIE (XSS)
    function stealCookie() {
        const httpOnly = document.getElementById('cfg-http').checked;
        const output = document.getElementById('stolen-sid');

        if (httpOnly) {
            output.innerText = "Error: Access Denied";
            output.style.color = "gray";
            alert("Attacker: XSS failed. HttpOnly flag prevented reading cookie.");
        } else {
            if (browserCookie) {
                output.innerText = `JSESSIONID=${browserCookie}`;
                output.style.color = "var(--attack-red)";
                alert("Attacker: XSS Successful! Cookie stolen.");
            } else {
                output.innerText = "No Cookie Found";
            }
        }
    }

    // 4. ATTACKER: CHECK ACCESS
    function checkAccess() {
        const res = document.getElementById('hack-result');
        // Attacker uses "666" (the fixed ID)
        const session = serverSessions[attackerSid];

        if (session && session.auth && session.user === 'alice') {
            res.innerText = "ACCESS GRANTED: Logged in as Alice!";
            res.style.color = "var(--attack-red)";
        } else {
            res.innerText = "ACCESS DENIED: Session invalid or unauthenticated.";
            res.style.color = "var(--safe-green)";
        }
    }

    function resetLab() {
        browserCookie = null;
        serverSessions = {};
        document.getElementById('stolen-sid').innerText = "-- Waiting --";
        document.getElementById('hack-result').innerText = "";
        
        // Reset Browser UI
        document.getElementById('page-body').innerHTML = `
            <div class="login-form">
                <h3>Login</h3>
                <input type="text" value="alice" readonly><br>
                <input type="password" value="password"><br>
                <button class="btn-login" onclick="login()">Sign In</button>
            </div>
            <div id="current-cookie" style="margin-top:20px; color:#666; font-size:0.8rem;">
                Current Cookie: <span id="cookie-val" class="cookie-badge">NONE</span>
            </div>
        `;
        updateUI();
    }

</script>

</body>
</html>