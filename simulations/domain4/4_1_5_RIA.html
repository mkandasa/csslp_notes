<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSSLP Domain 4: RIA Security</title>
    <style>
        :root {
            --bg: #0f172a;
            --panel: #1e293b;
            --text: #f8fafc;
            --accent: #f472b6; /* Pink */
            --risk: #ef4444;   /* Red */
            --secure: #10b981; /* Green */
            --code: #fbbf24;   /* Amber */
            --border: #334155;
        }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 { border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-bottom: 20px; text-align: center; }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn {
            background: var(--panel); color: #9ca3af;
            border: 1px solid var(--border); padding: 10px 20px;
            cursor: pointer; border-radius: 6px;
            font-weight: bold; transition: all 0.2s;
        }
        .tab-btn:hover { background: #374151; }
        .tab-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }
        
        .tab-content { display: none; width: 100%; max-width: 1000px; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: var(--panel); padding: 25px; border-radius: 12px;
            border: 1px solid var(--border); margin-bottom: 20px;
        }
        .card h3 { margin-top: 0; color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 10px; }

        /* --- Code Editor --- */
        .code-editor {
            background: #111; color: #ccc; font-family: monospace; padding: 15px; border-radius: 6px;
            border: 1px solid #444; white-space: pre-wrap; font-size: 0.9rem; position: relative;
        }
        .vuln-line { background: rgba(239, 68, 68, 0.2); border-left: 3px solid var(--risk); padding-left: 5px; cursor: pointer; }
        .vuln-line:hover { background: rgba(239, 68, 68, 0.4); }
        .secure-line { background: rgba(16, 185, 129, 0.2); border-left: 3px solid var(--secure); padding-left: 5px; }

        /* --- Browser Mockup --- */
        .browser {
            background: #fff; color: #000; border-radius: 6px; overflow: hidden; margin-top: 20px;
        }
        .browser-bar {
            background: #ddd; padding: 5px 10px; font-size: 0.8rem; display: flex; gap: 5px; align-items: center;
        }
        .url-bar {
            background: #fff; border: 1px solid #ccc; padding: 2px 5px; flex-grow: 1; font-family: monospace;
        }
        .browser-content { padding: 20px; min-height: 100px; text-align: center; }
        
        /* --- Price Manipulator --- */
        .product-box {
            display: flex; justify-content: space-between; align-items: center; background: #111; padding: 15px;
            border-radius: 6px; border: 1px solid #444;
        }
        .price-tag { font-size: 1.5rem; font-weight: bold; color: var(--code); }
        .console-mock {
            background: #000; border-top: 2px solid #444; padding: 10px; font-family: monospace; font-size: 0.8rem;
            color: #aaa; height: 100px; overflow-y: auto; margin-top: 10px;
        }
        .console-input { color: #fff; background: transparent; border: none; width: 100%; outline: none; }

        /* --- WebSocket Visuals --- */
        .ws-connection {
            display: flex; justify-content: space-between; align-items: center; padding: 20px;
            background: #000; border-radius: 8px; position: relative;
        }
        .ws-node {
            width: 80px; padding: 10px; background: #222; border: 2px solid #555; text-align: center; border-radius: 6px;
            z-index: 2;
        }
        .ws-line {
            position: absolute; top: 50%; left: 100px; right: 100px; height: 4px; background: #333; z-index: 1;
        }
        .ws-packet {
            width: 15px; height: 15px; background: var(--accent); border-radius: 50%; position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%); display: none;
        }

        /* --- Buttons --- */
        button {
            padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer;
            font-weight: bold; transition: opacity 0.2s; width: 100%; margin-top: 10px;
        }
        button:hover { opacity: 0.9; }
        .btn-hack { background: var(--risk); color: white; }
        .btn-fix { background: var(--secure); color: black; }
        .btn-test { background: var(--accent); color: black; width: auto; margin: 0; }

        /* --- Logs --- */
        .log-terminal {
            grid-column: span 2; background: #000; height: 120px; 
            padding: 10px; overflow-y: auto; font-family: monospace; 
            border: 1px solid var(--border); color: #a6e3a1; font-size: 0.9rem; margin-top: 20px; width: 100%; box-sizing: border-box;
        }
        .log-err { color: var(--risk); }
        .log-ok { color: var(--secure); }

    </style>
</head>
<body>

    <h1>CSSLP: Rich Internet Application (RIA) Security</h1>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('xss')">1. DOM-Based XSS</button>
        <button class="tab-btn" onclick="switchTab('logic')">2. Client-Side Logic</button>
        <button class="tab-btn" onclick="switchTab('ws')">3. WebSocket Hijacking</button>
    </div>

    <!-- TAB 1: DOM XSS -->
    <div id="xss" class="tab-content active">
        <div class="card">
            <h3>The "Unsafe Sink" Vulnerability</h3>
            <p><strong>Concept:</strong> The browser takes data from a source (URL) and puts it into a sink (innerHTML) without validation.</p>
            
            <div class="code-editor" id="xssSource">
// app.js (Client-Side)
const params = new URLSearchParams(window.location.search);
const username = params.get("user");

// VULNERABLE SINK:
<span class="vuln-line" onclick="patchXSS()">document.getElementById("welcome").innerHTML = username;</span>
            </div>
            
            <div class="browser">
                <div class="browser-bar">
                    <div class="url-bar" id="xssUrl">https://app.com?user=Alice</div>
                    <button class="btn-test" onclick="runXSSAttack()">Go</button>
                </div>
                <div class="browser-content" id="xssRender">
                    <h1>Welcome, <span id="welcomeSpan">Alice</span></h1>
                </div>
            </div>

            <div style="margin-top:10px; text-align:center; color:#aaa; font-size:0.8rem;">
                Click the red code line to apply the fix (textContent).
            </div>
        </div>
    </div>

    <!-- TAB 2: CLIENT-SIDE LOGIC -->
    <div id="logic" class="tab-content">
        <div class="card">
            <h3>Bypassing Client-Side Validation</h3>
            <p><strong>Scenario:</strong> The price is stored in a JavaScript variable. The server trusts the value sent by the client.</p>
            
            <div class="product-box">
                <div>
                    <strong>Premium Widget</strong><br>
                    <small>ID: 5591</small>
                </div>
                <div class="price-tag" id="displayPrice">$1,000.00</div>
            </div>

            <div class="console-mock" id="jsConsole">
                <span style="color:#4ade80">user@browser:~$</span> <span id="consoleHistory">Current Price: 1000</span><br>
                <span style="color:#4ade80">user@browser:~$</span> <input type="text" class="console-input" id="hackInput" placeholder="Type: price = 1" onchange="hackPrice()">
            </div>

            <button class="btn-hack" onclick="buyProduct()">Purchase Item</button>
            
            <div id="purchaseResult" style="margin-top:10px; text-align:center; font-weight:bold;"></div>
            
            <div style="margin-top:20px; border-top:1px solid #444; padding-top:10px;">
                <label><input type="checkbox" id="serverValid"> <strong>Enable Server-Side Validation</strong></label>
            </div>
        </div>
    </div>

    <!-- TAB 3: WEBSOCKETS -->
    <div id="ws" class="tab-content">
        <div class="card">
            <h3>WebSocket (CSWSH) Defense</h3>
            <p><strong>Threat:</strong> Cross-Site WebSocket Hijacking. Attacker site opens a socket to your server.</p>
            
            <div class="ws-connection">
                <div class="ws-node" style="border-color:var(--accent)">Browser<br>(Client)</div>
                <div class="ws-line"></div>
                <div class="ws-packet" id="wsPkt"></div>
                <div class="ws-node" style="border-color:var(--secure)">Server<br>(WSS)</div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px;">
                <div style="background:#111; padding:10px; border-radius:6px;">
                    <strong>Attack Request</strong><br>
                    <code style="font-size:0.8rem; color:#aaa">
                        GET /chat HTTP/1.1<br>
                        Host: bank.com<br>
                        Origin: <span id="wsOrigin">http://evil-attacker.com</span><br>
                        Cookie: session=123
                    </code>
                </div>
                <div>
                    <label><input type="checkbox" id="originCheck"> <strong>Enforce Origin Check</strong></label>
                    <button class="btn-hack" onclick="launchWSAttack()">Launch CSWSH Attack</button>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGS -->
    <div class="log-terminal" id="logs">
        <div>> RIA Security Console Ready.</div>
    </div>

    <script>
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            const map = {'xss':0, 'logic':1, 'ws':2};
            document.querySelectorAll('.tab-btn')[map[id]].classList.add('active');
        }

        function log(msg, type='info') {
            const term = document.getElementById('logs');
            const cls = type === 'err' ? 'log-err' : (type === 'ok' ? 'log-ok' : '');
            term.innerHTML += `<div class="${cls}">> ${msg}</div>`;
            term.scrollTop = term.scrollHeight;
        }

        /* --- XSS LOGIC --- */
        let xssFixed = false;

        function runXSSAttack() {
            const urlBar = document.getElementById('xssUrl');
            const payload = `<img src=x onerror=alert('XSS')>`;
            urlBar.value = `https://app.com?user=${payload}`;
            
            const span = document.getElementById('welcomeSpan');
            
            if (xssFixed) {
                // Safe Sink (textContent)
                span.innerText = payload;
                log("Browser: Rendered payload as text. Attack BLOCKED.", 'ok');
            } else {
                // Unsafe Sink (innerHTML)
                span.innerHTML = payload; // This usually triggers it, but for safety in this lab we simulate the alert
                alert("XSS EXECUTED! The browser ran the attacker's script.");
                log("Browser: Executed malicious script via innerHTML.", 'err');
            }
        }

        function patchXSS() {
            const code = document.getElementById('xssSource');
            code.innerHTML = `// app.js (Client-Side)
const params = new URLSearchParams(window.location.search);
const username = params.get("user");

// SECURE SINK:
<span class="secure-line">document.getElementById("welcome").textContent = username;</span>`;
            xssFixed = true;
            log("Code Patched: Switched to 'textContent' (Safe Sink).", 'ok');
        }

        /* --- CLIENT LOGIC --- */
        let productPrice = 1000;
        
        function hackPrice() {
            const input = document.getElementById('hackInput').value;
            if (input.includes("price = 1")) {
                productPrice = 1;
                document.getElementById('displayPrice').innerText = "$1.00";
                document.getElementById('consoleHistory').innerHTML += `<br><span style="color:#4ade80">user@browser:~$</span> price = 1<br>> Variable 'price' updated to 1.`;
                log("Client-Side: Variable 'price' modified in browser memory.", 'err');
            }
        }

        function buyProduct() {
            const serverCheck = document.getElementById('serverValid').checked;
            const res = document.getElementById('purchaseResult');
            
            if (serverCheck) {
                // Server knows the real price is 1000
                if (productPrice < 1000) {
                    res.innerText = "SERVER REJECTED: Price mismatch.";
                    res.style.color = "var(--secure)";
                    log("Server: Validation Failed. Client sent $1, Expected $1000.", 'ok');
                } else {
                    res.innerText = "Purchase Successful ($1000).";
                    res.style.color = "var(--secure)";
                }
            } else {
                // Server blindly trusts client
                res.innerText = `Purchase Successful for $${productPrice}!`;
                res.style.color = productPrice < 1000 ? "var(--risk)" : "var(--secure)";
                if(productPrice < 1000) log("Server: Accepted manipulated price! Financial Loss.", 'err');
            }
        }

        /* --- WEBSOCKET LOGIC --- */
        function launchWSAttack() {
            const check = document.getElementById('originCheck').checked;
            const pkt = document.getElementById('wsPkt');
            
            pkt.style.display = 'block';
            pkt.style.left = '10%';
            
            // Animate
            setTimeout(() => {
                pkt.style.transition = 'left 1s linear';
                pkt.style.left = '90%'; // To Server
                
                setTimeout(() => {
                    if (check) {
                        log("WebSocket Server: Handshake Rejected. Origin 'evil-attacker.com' not allowed.", 'ok');
                        pkt.style.backgroundColor = "var(--secure)";
                    } else {
                        log("WebSocket Server: Handshake Accepted. Hijacking Successful!", 'err');
                        pkt.style.backgroundColor = "var(--risk)";
                    }
                    pkt.style.display = 'none';
                    pkt.style.transition = 'none';
                }, 1000);
            }, 100);
        }

    </script>
</body>
</html>