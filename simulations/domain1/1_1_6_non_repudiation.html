<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSSLP Domain 1: Non-Repudiation Courtroom</title>
    <!-- Asymmetric Crypto Lib -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --panel: #1e293b;
            --text: #e2e8f0;
            --accent: #f59e0b; /* Amber for Legal/Proof */
            --valid: #10b981;
            --invalid: #ef4444;
            --blockchain: #6366f1;
        }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 { border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-bottom: 20px; }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn {
            background: var(--panel); color: #94a3b8;
            border: 1px solid #334155; padding: 10px 20px;
            cursor: pointer; border-radius: 6px;
            font-weight: bold; transition: all 0.2s;
        }
        .tab-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }
        
        .tab-content { display: none; width: 100%; max-width: 900px; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: var(--panel);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 1px solid #334155;
            margin-bottom: 20px;
        }

        input, textarea, select {
            width: 100%;
            padding: 10px; border-radius: 6px; border: 1px solid #475569;
            background: #0f172a; color: white; margin-top: 5px; margin-bottom: 15px;
            font-family: monospace; box-sizing: border-box;
        }
        
        button.action-btn { 
            cursor: pointer; background: var(--accent); border: none; 
            font-weight: bold; color: #000; padding: 10px 20px; border-radius: 6px;
        }
        button.action-btn:hover { opacity: 0.9; }

        /* Blockchain Styles */
        .chain-view { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; }
        .block {
            min-width: 200px; background: #334155; padding: 10px;
            border-radius: 8px; border-left: 4px solid var(--blockchain);
            font-size: 0.8rem; position: relative;
        }
        .block::after {
            content: 'üîó'; position: absolute; right: -15px; top: 40%; font-size: 1.2rem;
        }
        .block:last-child::after { content: ''; }
        .tx-row { background: #1e293b; padding: 5px; margin: 5px 0; border-radius: 4px; word-break: break-all; }
        .sig-tag { display: inline-block; padding: 2px 4px; background: var(--accent); color: black; font-size: 0.7rem; border-radius: 3px; }

        .key-display { font-size: 0.7rem; color: #94a3b8; height: 60px; overflow-y: auto; background: #000; padding: 5px; border-radius: 4px; }
    </style>
</head>
<body>

    <h1>CSSLP: Non-Repudiation Courtroom</h1>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('sign')">1. The Contract (Sign)</button>
        <button class="tab-btn" onclick="switchTab('verify')">2. The Trial (Verify)</button>
        <button class="tab-btn" onclick="switchTab('chain')">3. Blockchain Ledger</button>
    </div>

    <!-- TAB 1: SIGNING -->
    <div id="sign" class="tab-content active">
        <div class="card">
            <h2>Step 1: Generate Identity</h2>
            <p>You need a Private Key (Your Digital Signature Pen) and a Public Key (For the world to verify).</p>
            <button class="action-btn" onclick="generateKeys()">Generate Keys</button>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                <div>
                    <label>Your Private Key (SECRET):</label>
                    <div id="privKey" class="key-display">Not Generated</div>
                </div>
                <div>
                    <label>Your Public Key (SHARED):</label>
                    <div id="pubKey" class="key-display">Not Generated</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Step 2: Sign the Contract</h2>
            <label>Contract Text:</label>
            <textarea id="contractText">I, Alice, agree to pay Bob $10,000 for the consulting services.</textarea>
            
            <button class="action-btn" onclick="signContract()">Sign with Private Key</button>
            
            <label>Digital Signature (Base64):</label>
            <textarea id="signatureOutput" readonly style="color:var(--accent)">Waiting for signature...</textarea>
            <p style="font-size:0.8rem; color:#94a3b8">Note: This signature is unique to *this exact text* and *your private key*.</p>
        </div>
    </div>

    <!-- TAB 2: VERIFICATION -->
    <div id="verify" class="tab-content">
        <div class="card">
            <h2>The Courtroom: Verify Claims</h2>
            <p>Imagine Alice tries to deny the contract. The Judge uses her <strong>Public Key</strong> to verify the signature.</p>
            
            <label>Claimed Contract:</label>
            <textarea id="verifyText">I, Alice, agree to pay Bob $10,000 for the consulting services.</textarea>
            
            <label>Claimed Signature:</label>
            <textarea id="verifySig"></textarea>
            
            <label>Signer's Public Key:</label>
            <textarea id="verifyPubKey" class="key-display" style="height:80px;"></textarea>

            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="action-btn" onclick="verifyContract()">Verify Signature</button>
                <button class="action-btn" style="background:var(--invalid); color:white" onclick="tamperDoc()">Tamper with Contract</button>
            </div>

            <div id="verdict" style="margin-top:20px; font-weight:bold; font-size:1.2rem; text-align:center;"></div>
        </div>
    </div>

    <!-- TAB 3: BLOCKCHAIN -->
    <div id="chain" class="tab-content">
        <div class="card">
            <h2>Blockchain: The Immutable Ledger</h2>
            <p>Transactions are signed, then added to blocks. Because the block hash includes the previous block's hash, you cannot change history.</p>
            
            <div style="display:flex; gap:10px;">
                <input type="text" id="txData" placeholder="Tx: Alice -> Bob 5 BTC">
                <button class="action-btn" style="background:var(--blockchain); color:white" onclick="addBlock()">Sign & Mine Block</button>
            </div>

            <div class="chain-view" id="chainContainer">
                <!-- Genesis Block -->
                <div class="block">
                    <strong>Block #0 (Genesis)</strong>
                    <div class="tx-row">System Init</div>
                    <div style="margin-top:10px; font-size:0.7rem;">Hash: <span style="color:var(--blockchain)">0000abc...</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Cryptosystem
        let crypt = new JSEncrypt({default_key_size: 1024});
        let privateKey = null;
        let publicKey = null;

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            const map = {'sign':0, 'verify':1, 'chain':2};
            document.querySelectorAll('.tab-btn')[map[id]].classList.add('active');
        }

        // --- SIGNING ---
        function generateKeys() {
            document.getElementById('privKey').innerText = "Generating...";
            setTimeout(() => {
                crypt.getKey(() => {
                    privateKey = crypt.getPrivateKey();
                    publicKey = crypt.getPublicKey();
                    
                    document.getElementById('privKey').innerText = privateKey;
                    document.getElementById('pubKey').innerText = publicKey;
                    
                    // Auto-fill verification tab for convenience
                    document.getElementById('verifyPubKey').value = publicKey;
                });
            }, 500);
        }

        function signContract() {
            if(!privateKey) { alert("Generate keys first!"); return; }
            const text = document.getElementById('contractText').value;
            
            // Sign
            let sig = crypt.sign(text, CryptoJS.SHA256, "sha256");
            
            document.getElementById('signatureOutput').value = sig;
            document.getElementById('verifySig').value = sig;
            document.getElementById('verifyText').value = text;
        }

        // --- VERIFICATION ---
        function verifyContract() {
            const text = document.getElementById('verifyText').value;
            const sig = document.getElementById('verifySig').value;
            const pub = document.getElementById('verifyPubKey').value;
            const verdict = document.getElementById('verdict');

            if(!sig || !pub) { alert("Missing signature or key"); return; }

            // Verify
            let verifyEngine = new JSEncrypt();
            verifyEngine.setPublicKey(pub);
            let isValid = verifyEngine.verify(text, sig, CryptoJS.SHA256);

            if(isValid) {
                verdict.innerHTML = `<span style="color:var(--valid)">‚úÖ VERDICT: VALID.</span><br><small>Alice definitely signed this exact text. Non-repudiation upheld.</small>`;
                verdict.style.border = "1px solid var(--valid)";
                verdict.style.padding = "10px";
            } else {
                verdict.innerHTML = `<span style="color:var(--invalid)">‚ùå VERDICT: FRAUD DETECTED.</span><br><small>Signature does not match text or key. Evidence rejected.</small>`;
                verdict.style.border = "1px solid var(--invalid)";
                verdict.style.padding = "10px";
            }
        }

        function tamperDoc() {
            const el = document.getElementById('verifyText');
            el.value = el.value.replace("$10,000", "$100,000"); // Change amount
            verifyContract();
        }

        // --- BLOCKCHAIN ---
        let chain = [];
        let prevHash = "0000000000";

        function addBlock() {
            if(!privateKey) { alert("Generate Identity (Keys) in Tab 1 first!"); return; }
            
            const data = document.getElementById('txData').value || "Empty Transaction";
            const id = chain.length + 1;
            
            // 1. Sign Transaction
            const signature = crypt.sign(data, CryptoJS.SHA256, "sha256");
            const shortSig = signature.substring(0, 10) + "...";

            // 2. Mine Block (Simple Hash)
            const blockContent = id + data + prevHash + signature;
            const blockHash = CryptoJS.SHA256(blockContent).toString().substring(0, 15);

            // Render
            const container = document.getElementById('chainContainer');
            const el = document.createElement('div');
            el.className = 'block';
            el.innerHTML = `
                <strong>Block #${id}</strong>
                <div class="tx-row">
                    ${data}<br>
                    <span class="sig-tag">Signed: ${shortSig}</span>
                </div>
                <div style="margin-top:10px; font-size:0.7rem;">
                    Prev: ${prevHash.substring(0,8)}...<br>
                    <strong>Hash: <span style="color:var(--blockchain)">${blockHash}...</span></strong>
                </div>
            `;
            container.appendChild(el);
            
            // Scroll to end
            container.scrollLeft = container.scrollWidth;

            // Update state
            prevHash = blockHash;
            document.getElementById('txData').value = "";
        }

    </script>
</body>
</html>