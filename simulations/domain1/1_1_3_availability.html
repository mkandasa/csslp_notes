<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSSLP Domain 1: Advanced Availability Architecture</title>
    <style>
        :root {
            --bg: #0f172a;
            --panel: #1e293b;
            --text: #e2e8f0;
            --primary: #3b82f6; /* Web Tier Blue */
            --db-active: #10b981; /* DB Green */
            --db-replica: #8b5cf6; /* DB Purple */
            --danger: #ef4444;
            --packet-read: #60a5fa;
            --packet-write: #fcd34d;
        }
        body {
            font-family: 'Segoe UI', monospace;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- Architecture Layout --- */
        .arch-container {
            display: grid;
            grid-template-rows: auto 1fr 1fr;
            gap: 20px;
            width: 100%;
            max-width: 1000px;
            background: #020617;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 20px;
            position: relative;
            min-height: 600px;
        }

        /* Layers */
        .layer {
            border: 2px dashed #334155;
            border-radius: 8px;
            padding: 15px;
            position: relative;
        }
        .layer-label {
            position: absolute;
            top: -12px;
            left: 20px;
            background: var(--bg);
            padding: 0 10px;
            color: #94a3b8;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* 1. Load Balancer Zone */
        .lb-zone { display: flex; justify-content: center; align-items: center; height: 80px; }
        .lb {
            width: 120px; height: 40px;
            background: var(--text); color: var(--bg);
            border-radius: 20px;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; z-index: 2;
            box-shadow: 0 0 15px rgba(255,255,255,0.2);
        }

        /* 2. Web Cluster Zone */
        .web-zone { 
            display: flex; 
            justify-content: center; 
            gap: 20px; 
            min-height: 120px;
            align-items: center;
        }
        .server {
            width: 70px; height: 90px;
            background: var(--primary);
            border-radius: 4px;
            position: relative;
            transition: all 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            border-bottom: 4px solid #1d4ed8;
        }
        .server::after { content: 'WEB'; font-size: 10px; margin-bottom: 5px; opacity: 0.8; }
        .server-led { 
            width: 8px; height: 8px; background: #86efac; border-radius: 50%; 
            position: absolute; top: 10px; right: 10px; 
            box-shadow: 0 0 5px #86efac;
            transition: background 0.2s;
        }
        /* Request Counter Badge */
        .req-count {
            position: absolute;
            top: 35px;
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* 3. Data Tier Zone */
        .data-zone {
            display: flex;
            justify-content: space-around;
            align-items: center;
            min-height: 150px;
        }
        .db-node {
            width: 100px; height: 120px;
            background: #334155;
            border-radius: 50% 50% 10px 10px / 20px 20px 0 0; /* Cylinder shape */
            position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 3px solid #475569;
            transition: all 0.3s;
        }
        .db-node::before {
            content: ''; position: absolute; top: -15px; left: -3px; right: -3px; height: 30px;
            background: inherit; border: 3px solid #475569; border-radius: 50%;
            z-index: 1;
        }
        .db-label { z-index: 2; font-weight: bold; font-size: 0.9rem; margin-top: 10px; }
        .db-role { z-index: 2; font-size: 0.7rem; opacity: 0.7; text-transform: uppercase; }
        
        .db-primary { border-color: var(--db-active); background: #064e3b; }
        .db-primary::before { border-color: var(--db-active); background: #064e3b; }
        
        .db-replica { border-color: var(--db-replica); background: #4c1d95; }
        .db-replica::before { border-color: var(--db-replica); background: #4c1d95; }

        .db-dead { filter: grayscale(1); opacity: 0.5; border-color: var(--danger) !important; }

        /* Replication Link */
        .replication-pipe {
            height: 10px; flex-grow: 0.5;
            background: #1e293b; border: 1px solid #334155;
            position: relative;
            border-radius: 5px;
        }
        .repl-dot {
            width: 8px; height: 8px; background: white; border-radius: 50%;
            position: absolute; top: 1px;
        }

        /* Packets */
        .packet {
            width: 12px; height: 12px; border-radius: 50%;
            position: absolute; z-index: 100;
            box-shadow: 0 0 8px rgba(255,255,255,0.5);
        }
        .pkt-read { background: var(--packet-read); }
        .pkt-write { background: var(--packet-write); border: 2px solid white; }

        /* Controls */
        .controls {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;
            width: 100%; max-width: 1000px;
            margin-top: 20px;
        }
        .panel { background: var(--panel); padding: 15px; border-radius: 8px; border: 1px solid #334155; }
        .panel h3 { margin: 0 0 10px 0; font-size: 0.9rem; color: #94a3b8; text-transform: uppercase; }
        
        button {
            display: block; width: 100%; padding: 8px; margin-bottom: 8px;
            border: none; border-radius: 4px; font-weight: bold; cursor: pointer;
            font-size: 0.8rem;
        }
        .btn-add { background: var(--primary); color: white; }
        .btn-kill { background: var(--danger); color: white; }
        .btn-action { background: var(--text); color: var(--bg); }
        
        .toggle-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; margin-bottom: 8px;}
        .status-badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; background: #334155; }

    </style>
</head>
<body>

    <h1 style="margin-bottom: 5px;">CSSLP: The Availability Architect</h1>
    <p style="margin-top:0; color:#94a3b8; font-size: 0.9rem;">Simulate Redundancy, Clustering, and Replication in real-time.</p>

    <div class="arch-container" id="canvas">
        
        <!-- Layer 1: Ingress -->
        <div class="layer lb-zone">
            <div class="layer-label">Ingress Tier</div>
            <div class="lb" id="lbElement">Load Balancer</div>
        </div>

        <!-- Layer 2: Compute -->
        <div class="layer web-zone" id="webCluster">
            <div class="layer-label">Compute Tier (Clustered)</div>
            <!-- Servers injected by JS -->
        </div>

        <!-- Layer 3: Data -->
        <div class="layer data-zone">
            <div class="layer-label">Persistence Tier (Replicated)</div>
            
            <div class="db-node db-primary" id="dbPrimary">
                <div class="db-label">DB-01</div>
                <div class="db-role">Primary (R/W)</div>
            </div>

            <div class="replication-pipe" id="replPipe">
                <!-- Visual dots for replication -->
            </div>

            <div class="db-node db-replica" id="dbReplica">
                <div class="db-label">DB-02</div>
                <div class="db-role">Replica (Read Only)</div>
            </div>
        </div>

    </div>

    <!-- Control Panels -->
    <div class="controls">
        
        <!-- Clustering Controls -->
        <div class="panel">
            <h3>Clustering & Scalability</h3>
            <div class="toggle-row">
                <span>Active Nodes:</span>
                <span id="nodeCountBadge" class="status-badge">3</span>
            </div>
            <button class="btn-add" onclick="scaleUp()">+ Scale Out (Add Node)</button>
            <button class="btn-kill" onclick="killWebNode()">- Scale In / Fail Node</button>
            <p style="font-size:0.75rem; color:#64748b;">Notice how traffic is distributed across active nodes (Round-Robin). Counters show the load share.</p>
        </div>

        <!-- Traffic Controls -->
        <div class="panel">
            <h3>Traffic Simulator</h3>
            <button class="btn-action" style="background:var(--packet-read); color:black" onclick="sendTraffic('read')">Generate READ Request</button>
            <button class="btn-action" style="background:var(--packet-write); color:black" onclick="sendTraffic('write')">Generate WRITE Request</button>
            <div class="toggle-row" style="margin-top:10px;">
                <span>Read From Replica:</span>
                <input type="checkbox" id="readReplicaToggle" checked>
            </div>
             <p style="font-size:0.75rem; color:#64748b;">Writes MUST go to Primary. Reads can be load balanced to Replica to improve performance.</p>
        </div>

        <!-- Redundancy Controls -->
        <div class="panel">
            <h3>Redundancy & Failover</h3>
            <button class="btn-kill" onclick="killDB('primary')">☠️ Kill Primary DB</button>
            <button class="btn-add" onclick="recoverDB()">♻️ Recover/Reset DBs</button>
            <div class="toggle-row" style="margin-top:10px;">
                <span>Replication Mode:</span>
                <select id="replMode" style="background:#334155; color:white; border:none; padding:2px;">
                    <option value="async">Async (Fast)</option>
                    <option value="sync">Sync (Safe)</option>
                </select>
            </div>
            <p style="font-size:0.75rem; color:#64748b;">Primary failure triggers Failover. Sync replication ensures zero data loss but adds latency.</p>
        </div>

    </div>

    <script>
        // --- State ---
        let webNodes = 3;
        const MAX_NODES = 6;
        let rrIndex = 0; // Round Robin Index
        let dbState = {
            primaryAlive: true,
            replicaAlive: true,
            isFailover: false
        };

        // --- Init ---
        window.onload = () => {
            renderWebNodes();
        };

        // --- Web Cluster Logic ---
        function renderWebNodes() {
            const container = document.getElementById('webCluster');
            container.innerHTML = '<div class="layer-label">Compute Tier (Clustered)</div>';
            
            for(let i=0; i<webNodes; i++) {
                const node = document.createElement('div');
                node.className = 'server';
                node.id = `web-${i}`;
                // Added Req Count <span>
                node.innerHTML = `
                    <div class="server-led"></div>
                    <span class="req-count" id="count-${i}">0</span>
                `;
                container.appendChild(node);
            }
            document.getElementById('nodeCountBadge').innerText = webNodes;
        }

        function scaleUp() {
            if(webNodes < MAX_NODES) {
                webNodes++;
                renderWebNodes();
            }
        }

        function killWebNode() {
            if(webNodes > 1) {
                webNodes--;
                renderWebNodes();
            } else {
                alert("Cannot kill last web node! System would be totally down.");
            }
        }

        // --- Database Logic ---
        function killDB(target) {
            if(target === 'primary' && dbState.primaryAlive) {
                dbState.primaryAlive = false;
                document.getElementById('dbPrimary').classList.add('db-dead');
                document.getElementById('dbPrimary').querySelector('.db-role').innerText = "FAILED";
                
                // Trigger Failover Logic
                setTimeout(() => {
                    if(dbState.replicaAlive) {
                        performFailover();
                    } else {
                        alert("TOTAL SYSTEM FAILURE: All DBs are down.");
                    }
                }, 1000);
            }
        }

        function performFailover() {
            alert("ALERT: Primary DB Heartbeat Lost. Initiating Failover to Replica...");
            dbState.isFailover = true;
            
            const replica = document.getElementById('dbReplica');
            replica.classList.remove('db-replica');
            replica.classList.add('db-primary'); // Promote visual
            replica.querySelector('.db-role').innerText = "Promoted Primary (R/W)";
            replica.querySelector('.db-label').innerText = "DB-02 (Active)";
        }

        function recoverDB() {
            dbState = { primaryAlive: true, replicaAlive: true, isFailover: false };
            
            // Reset Visuals
            const p = document.getElementById('dbPrimary');
            p.className = 'db-node db-primary';
            p.querySelector('.db-role').innerText = "Primary (R/W)";
            
            const r = document.getElementById('dbReplica');
            r.className = 'db-node db-replica';
            r.querySelector('.db-label').innerText = "DB-02";
            r.querySelector('.db-role').innerText = "Replica (Read Only)";
        }

        // --- Traffic & Animation Logic ---
        function sendTraffic(type) {
            // 1. Packet created at LB
            const pkt = document.createElement('div');
            pkt.className = `packet ${type === 'write' ? 'pkt-write' : 'pkt-read'}`;
            document.body.appendChild(pkt);

            const lb = document.getElementById('lbElement');
            const lbRect = lb.getBoundingClientRect();
            
            // Start at LB
            pkt.style.left = (lbRect.left + lbRect.width/2 - 6) + 'px';
            pkt.style.top = (lbRect.top + lbRect.height/2 - 6) + 'px';

            // 2. Select Web Node (Round Robin)
            const targetWebIndex = rrIndex % webNodes;
            rrIndex++; // Increment for next time
            
            const webNode = document.getElementById(`web-${targetWebIndex}`);
            const webRect = webNode.getBoundingClientRect();

            // Animate LB -> Web
            const anim1 = pkt.animate([
                { transform: 'translate(0,0)' },
                { transform: `translate(${webRect.left - parseFloat(pkt.style.left) + 25}px, ${webRect.top - parseFloat(pkt.style.top) + 40}px)` }
            ], { duration: 400, easing: 'ease-in-out', fill: 'forwards' });

            anim1.onfinish = () => {
                // VISUAL FEEDBACK ON WEB SERVER
                // 1. Flash LED
                const led = webNode.querySelector('.server-led');
                led.style.background = '#fcd34d'; // Yellow processing color
                led.style.boxShadow = '0 0 10px #fcd34d';
                
                // 2. Pulse Server
                webNode.style.transform = 'scale(1.1)';
                
                // 3. Update Counter
                const counter = document.getElementById(`count-${targetWebIndex}`);
                counter.innerText = parseInt(counter.innerText) + 1;

                // Reset visual after brief pause
                setTimeout(() => {
                    led.style.background = '#86efac';
                    led.style.boxShadow = '0 0 5px #86efac';
                    webNode.style.transform = 'scale(1)';
                }, 200);


                // Update new coordinates for next hop
                const currX = webRect.left + 25;
                const currY = webRect.top + 40;

                // 3. Determine DB Target
                let targetDB = null;
                let isReplicationNeeded = false;

                if (type === 'write') {
                    // Writes MUST go to Primary (or Promoted Replica)
                    if (dbState.isFailover) {
                        targetDB = document.getElementById('dbReplica');
                    } else if (dbState.primaryAlive) {
                        targetDB = document.getElementById('dbPrimary');
                        isReplicationNeeded = true;
                    } else {
                        // Drop packet
                        pkt.style.background = 'red';
                        pkt.remove();
                        return;
                    }
                } else {
                    // Reads
                    const useReplica = document.getElementById('readReplicaToggle').checked;
                    if (useReplica && dbState.replicaAlive && !dbState.isFailover) {
                        targetDB = document.getElementById('dbReplica');
                    } else if (dbState.primaryAlive || dbState.isFailover) {
                        targetDB = dbState.isFailover ? document.getElementById('dbReplica') : document.getElementById('dbPrimary');
                    } else {
                         pkt.remove(); return;
                    }
                }

                const dbRect = targetDB.getBoundingClientRect();

                // Animate Web -> DB
                const anim2 = pkt.animate([
                    { transform: `translate(${currX - parseFloat(pkt.style.left)}px, ${currY - parseFloat(pkt.style.top)}px)` },
                    { transform: `translate(${dbRect.left - parseFloat(pkt.style.left) + 50}px, ${dbRect.top - parseFloat(pkt.style.top) + 20}px)` }
                ], { duration: 400, easing: 'ease-in-out', fill: 'forwards' });

                anim2.onfinish = () => {
                    pkt.remove();
                    // Visual pulse on DB
                    targetDB.style.transform = "scale(1.1)";
                    setTimeout(() => targetDB.style.transform = "scale(1)", 100);

                    // 4. Trigger Replication if needed
                    if (isReplicationNeeded && dbState.replicaAlive) {
                        triggerReplication();
                    }
                };
            };
        }

        function triggerReplication() {
            const pipe = document.getElementById('replPipe');
            const dot = document.createElement('div');
            dot.className = 'repl-dot';
            pipe.appendChild(dot);

            const mode = document.getElementById('replMode').value;
            const duration = mode === 'sync' ? 800 : 300; 
            // Sync is slower visually to imply latency wait

            const anim = dot.animate([
                { left: '0%' },
                { left: '98%' }
            ], { duration: duration, easing: 'linear' });

            anim.onfinish = () => {
                dot.remove();
                // Pulse Replica
                const r = document.getElementById('dbReplica');
                r.style.boxShadow = "0 0 15px var(--db-replica)";
                setTimeout(() => r.style.boxShadow = "none", 200);
            };
        }

    </script>
</body>
</html>