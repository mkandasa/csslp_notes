<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSSLP Domain 5: Vulnerability Lab</title>
    <style>
        :root {
            --bg-dark: #0f172a;
            --panel-bg: #1e293b;
            --vuln-orange: #f97316;
            --crit-red: #ef4444;
            --high-orange: #f59e0b;
            --med-yellow: #eab308;
            --low-green: #22c55e;
            --text: #f1f5f9;
            --border: #334155;
        }
        body {
            font-family: 'Segoe UI', monospace;
            background-color: var(--bg-dark);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        header {
            background: #000;
            width: 100%;
            padding: 15px 0;
            text-align: center;
            border-bottom: 3px solid var(--vuln-orange);
            margin-bottom: 20px;
        }
        h1 { margin: 0; font-size: 1.5rem; color: var(--vuln-orange); }

        .dashboard {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            width: 95%;
            max-width: 1400px;
            height: 700px;
        }

        /* CONTROLS */
        .controls {
            background: var(--panel-bg);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #334155;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .section-title {
            color: #94a3b8;
            font-size: 0.8rem;
            text-transform: uppercase;
            border-bottom: 1px solid #475569;
            padding-bottom: 5px;
            margin-bottom: 5px;
        }

        .finding-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .finding-card {
            background: #334155;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #aaa;
            cursor: pointer;
            transition: 0.2s;
        }
        .finding-card:hover { transform: translateX(5px); background: #475569; }
        .finding-card.active { border-left-color: var(--vuln-orange); background: rgba(249, 115, 22, 0.2); }
        .finding-card.fixed { opacity: 0.5; border-left-color: var(--low-green); text-decoration: line-through; }

        .f-title { font-weight: bold; font-size: 0.9rem; }
        .f-meta { font-size: 0.75rem; color: #ccc; margin-top: 5px; }

        /* ANALYSIS PANEL */
        .analysis-panel {
            background: #000;
            border: 2px solid #334155;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .detail-view {
            border-bottom: 1px solid #333;
            padding-bottom: 20px;
        }
        h2 { margin-top: 0; color: var(--text); }
        .code-snippet {
            background: #0d1117;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #ccc;
            font-size: 0.9rem;
            border: 1px solid #333;
            margin: 10px 0;
        }
        .hl { color: var(--crit-red); font-weight: bold; text-decoration: underline; }

        /* Classification Form */
        .class-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: #aaa; }
        select {
            width: 100%;
            padding: 10px;
            background: #1e293b;
            color: white;
            border: 1px solid #555;
            border-radius: 4px;
        }

        button {
            width: 100%;
            padding: 12px;
            background: var(--vuln-orange);
            color: black;
            font-weight: bold;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
        }
        button:hover { filter: brightness(1.1); }

        /* LOGS */
        .console {
            margin-top: auto;
            background: #0d1117;
            border: 1px solid #334155;
            height: 120px;
            padding: 10px;
            font-family: monospace;
            font-size: 0.85rem;
            color: #aaa;
            overflow-y: auto;
        }
        .log-succ { color: var(--low-green); }
        .log-err { color: var(--crit-red); }

    </style>
</head>
<body>

<header>
    <h1>Vulnerability Triage Lab</h1>
    <p>Mapping Findings to CWE, OWASP & CVSS</p>
</header>

<div class="dashboard">

    <!-- FINDINGS LIST -->
    <div class="controls">
        <div class="section-title">Scanner Findings</div>
        <div class="finding-list" id="list">
            <!-- Injected via JS -->
        </div>
        
        <div style="margin-top:auto; font-size:0.8rem; color:#666;">
            Select a finding to analyze.
        </div>
    </div>

    <!-- ANALYSIS -->
    <div class="analysis-panel">
        
        <div id="empty-state" style="text-align:center; color:#555; margin-top:100px;">
            Select a finding from the left to begin triage.
        </div>

        <div id="detail-content" style="display:none;">
            <div class="detail-view">
                <h2 id="vuln-title">Title</h2>
                <div class="code-snippet" id="vuln-code">
                    Code...
                </div>
                <p id="vuln-desc">Description...</p>
            </div>

            <div class="section-title">Triage & Classification</div>
            <div class="class-form">
                <div>
                    <label>1. Identify CWE (Weakness Type)</label>
                    <select id="sel-cwe">
                        <option value="">-- Select CWE --</option>
                        <option value="CWE-89">CWE-89: SQL Injection</option>
                        <option value="CWE-79">CWE-79: Cross-Site Scripting (XSS)</option>
                        <option value="CWE-200">CWE-200: Info Exposure</option>
                        <option value="CWE-22">CWE-22: Path Traversal</option>
                    </select>
                </div>
                <div>
                    <label>2. Map to OWASP Top 10 (2021)</label>
                    <select id="sel-owasp">
                        <option value="">-- Select OWASP Category --</option>
                        <option value="A01">A01: Broken Access Control</option>
                        <option value="A03">A03: Injection</option>
                        <option value="A05">A05: Security Misconfig</option>
                        <option value="A09">A09: Logging Failures</option>
                    </select>
                </div>
                <div>
                    <label>3. Assign Severity (CVSS Proxy)</label>
                    <select id="sel-sev">
                        <option value="">-- Select Severity --</option>
                        <option value="Critical">Critical (Immediate Fix)</option>
                        <option value="High">High (Next Sprint)</option>
                        <option value="Medium">Medium (Backlog)</option>
                        <option value="Low">Low (Accept Risk)</option>
                    </select>
                </div>
                <div>
                    <label>4. Select Remediation</label>
                    <select id="sel-fix">
                        <option value="">-- Select Fix --</option>
                        <option value="Encode">Output Encoding</option>
                        <option value="Parameterize">Parameterized Queries</option>
                        <option value="Mask">Data Masking</option>
                        <option value="Sanitize">Input Sanitization</option>
                    </select>
                </div>
            </div>

            <button onclick="submitTriage()">Submit Triage</button>
        </div>

        <!-- LOGS -->
        <div class="console" id="logger">
            <div>> Triage Console Ready.</div>
        </div>

    </div>

</div>

<script>
    const findings = [
        {
            id: 1,
            title: "Unsanitized DB Query",
            file: "login.js:22",
            code: `db.execute("SELECT * FROM users WHERE user = '" + <span class="hl">req.body.user</span> + "'");`,
            desc: "User input is concatenated directly into a database query string.",
            correct: { cwe: "CWE-89", owasp: "A03", sev: "Critical", fix: "Parameterize" }
        },
        {
            id: 2,
            title: "Reflected Input in DOM",
            file: "search.php:15",
            code: `echo "<div>You searched for: " . <span class="hl">$_GET['q']</span> . "</div>";`,
            desc: "User input is echoed back to the browser without encoding.",
            correct: { cwe: "CWE-79", owasp: "A03", sev: "High", fix: "Encode" }
        },
        {
            id: 3,
            title: "Stack Trace Leak",
            file: "config.xml",
            code: `<customErrors mode="<span class="hl">Off</span>" />`,
            desc: "Application is configured to show full stack traces to remote users.",
            correct: { cwe: "CWE-200", owasp: "A05", sev: "Medium", fix: "Mask" } // Or Config fix, mapping Masking as generic 'hide info'
        }
    ];

    let currentFinding = null;

    // Init List
    const list = document.getElementById('list');
    findings.forEach(f => {
        const card = document.createElement('div');
        card.className = "finding-card";
        card.id = `card-${f.id}`;
        card.onclick = () => loadFinding(f.id);
        card.innerHTML = `
            <div class="f-title">#${f.id}: ${f.title}</div>
            <div class="f-meta">File: ${f.file}</div>
        `;
        list.appendChild(card);
    });

    function log(msg, type) {
        const box = document.getElementById('logger');
        const div = document.createElement('div');
        const time = new Date().toLocaleTimeString().split(' ')[0];
        div.innerHTML = `<span style="color:#555">[${time}]</span> <span class="${type==='succ'?'log-succ':(type==='err'?'log-err':'')}">${msg}</span>`;
        box.prepend(div);
    }

    function loadFinding(id) {
        currentFinding = findings.find(f => f.id === id);
        
        // UI
        document.querySelectorAll('.finding-card').forEach(c => c.classList.remove('active'));
        document.getElementById(`card-${id}`).classList.add('active');
        document.getElementById('empty-state').style.display = 'none';
        document.getElementById('detail-content').style.display = 'block';

        // Fill Data
        document.getElementById('vuln-title').innerText = `Finding #${id}: ${currentFinding.title}`;
        document.getElementById('vuln-code').innerHTML = currentFinding.code;
        document.getElementById('vuln-desc').innerText = currentFinding.desc;

        // Reset Form
        document.getElementById('sel-cwe').value = "";
        document.getElementById('sel-owasp').value = "";
        document.getElementById('sel-sev').value = "";
        document.getElementById('sel-fix').value = "";
    }

    function submitTriage() {
        if(!currentFinding) return;

        const cwe = document.getElementById('sel-cwe').value;
        const owasp = document.getElementById('sel-owasp').value;
        const sev = document.getElementById('sel-sev').value;
        const fix = document.getElementById('sel-fix').value;

        // Validation Logic
        let score = 0;
        let errors = [];

        if (cwe !== currentFinding.correct.cwe) errors.push(`Incorrect CWE. Hint: ${currentFinding.correct.cwe}`);
        if (owasp !== currentFinding.correct.owasp) errors.push(`Incorrect OWASP. Hint: ${currentFinding.correct.owasp}`);
        
        // Severity is somewhat subjective, but we enforce specific answers for the lab
        if (sev !== currentFinding.correct.sev) errors.push(`Severity Mismatch. Expected: ${currentFinding.correct.sev}`);
        
        // Fix
        // Map "Mask" to "Configuration" for finding 3 if needed, but keeping simple
        if (fix !== currentFinding.correct.fix) errors.push(`Wrong Remediation. Best practice is: ${currentFinding.correct.fix}`);

        if (errors.length === 0) {
            log(`SUCCESS: Finding #${currentFinding.id} triaged correctly!`, "succ");
            document.getElementById(`card-${currentFinding.id}`).classList.add('fixed');
            document.getElementById('detail-content').style.display = 'none';
            document.getElementById('empty-state').style.display = 'block';
            document.getElementById('empty-state').innerText = "Finding Closed. Select another.";
            currentFinding = null;
        } else {
            log(`TRIAGE FAILED: ${errors.length} Errors.`, "err");
            errors.forEach(e => log(`> ${e}`, "err"));
        }
    }

</script>

</body>
</html>