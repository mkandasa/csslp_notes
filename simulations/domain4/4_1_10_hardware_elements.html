<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSSLP Domain 4: Hardware Security Lab</title>
    <style>
        :root {
            --bg-dark: #1e1e1e;
            --panel-bg: #252526;
            --accent: #007acc;
            --danger: #ff5252;
            --success: #4caf50;
            --warning: #ffb74d;
            --text: #d4d4d4;
            --code-bg: #1e1e1e;
        }
        body {
            font-family: 'Segoe UI', Consolas, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        header {
            background: #2d2d2d;
            width: 100%;
            padding: 15px 0;
            text-align: center;
            border-bottom: 3px solid var(--accent);
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        h1 { margin: 0; font-size: 1.5rem; color: #fff; }
        
        .workspace {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 95%;
            max-width: 1200px;
            margin-top: 20px;
            margin-bottom: 40px;
        }

        /* LAB CARDS */
        .lab-card {
            background: var(--panel-bg);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #3e3e42;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }
        .lab-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #3e3e42;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .lab-title { font-size: 1.2rem; font-weight: bold; color: var(--accent); }
        
        /* VISUALIZATION AREAS */
        .viz-box {
            background: #111;
            border-radius: 6px;
            height: 200px;
            position: relative;
            margin: 15px 0;
            overflow: hidden;
            border: 1px solid #555;
            font-family: monospace;
            padding: 10px;
        }

        /* CONTROLS */
        button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
            margin-right: 5px;
            margin-top: 5px;
        }
        button:hover { background: #005f9e; }
        button.btn-danger { background: var(--danger); color: #000; }
        button.btn-danger:hover { background: #d32f2f; }
        button.btn-success { background: var(--success); color: #000; }
        button:disabled { background: #555; cursor: not-allowed; }
        
        .code-block {
            background: var(--code-bg);
            border-left: 3px solid var(--accent);
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #9cdcfe;
            margin-bottom: 10px;
            height: 80px;
            overflow-y: auto;
        }

        /* LAB 1: TIMING ATTACK STYLES */
        .timing-bar-container { margin-top: 10px; }
        .timing-bar {
            height: 20px;
            background: var(--danger);
            width: 0%;
            transition: width 0.1s ease-out;
            border-radius: 2px;
        }
        .timing-label { font-size: 0.8rem; color: #aaa; display: flex; justify-content: space-between; }

        /* LAB 2: SPECTRE STYLES */
        .cpu-pipeline {
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 100%;
        }
        .stage {
            border: 2px solid #555;
            padding: 10px;
            border-radius: 6px;
            width: 80px;
            text-align: center;
            font-size: 0.8rem;
            background: #2d2d2d;
            transition: 0.3s;
        }
        .stage.active { border-color: var(--accent); box-shadow: 0 0 10px var(--accent); color: white; }
        .stage.secret { border-color: var(--danger); box-shadow: 0 0 10px var(--danger); }
        
        /* LAB 3: SECURE ELEMENT STYLES */
        .se-layout { display: flex; height: 100%; align-items: center; justify-content: space-around; }
        .chip {
            width: 100px; height: 120px;
            border-radius: 8px;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            font-weight: bold; font-size: 0.9rem;
            position: relative;
        }
        .chip-cpu { background: #37474f; border: 2px solid #cfd8dc; }
        .chip-se { background: #263238; border: 2px solid var(--success); box-shadow: 0 0 15px rgba(76, 175, 80, 0.1); }
        .lock-icon { font-size: 2rem; margin-bottom: 5px; }
        .data-path { height: 4px; background: #555; width: 50px; }
        .msg-bubble { 
            position: absolute; top: -30px; background: #fff; color: #000; 
            padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; opacity: 0;
            transition: opacity 0.5s; width: max-content;
        }

        /* LAB 4: FIRMWARE/DMA STYLES */
        .dma-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; height: 100%; padding: 10px; }
        .ram-block { 
            grid-column: 2; grid-row: 1 / span 2; 
            background: #1a237e; border: 1px solid #534bae; 
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        .peripheral { 
            background: #b71c1c; padding: 10px; border-radius: 4px; color: white;
            display: flex; align-items: center; justify-content: center; font-size: 0.8rem;
        }
        .iommu-gate {
            position: absolute; left: -10px; top: 0; bottom: 0; width: 10px;
            background: #555; transition: 0.3s;
        }
        .iommu-gate.active { background: var(--success); box-shadow: -2px 0 10px var(--success); }

    </style>
</head>
<body>

<header>
    <h1>CSSLP Domain 4: Hardware & Embedded Security</h1>
    <p>Simulating Side-Channels, Roots of Trust, and DMA Protection</p>
</header>

<div class="workspace">

    <!-- LAB 1: TIMING ATTACK -->
    <div class="lab-card">
        <div class="lab-header">
            <span class="lab-title">1. Timing Attack (Side-Channel)</span>
        </div>
        <p style="font-size:0.9rem; color:#aaa;">Insecure comparison exits early on mismatch. Attackers measure this duration.</p>

        <div class="code-block" id="timing-code">
// Insecure: Fast Fail
for (i=0; i < len; i++) {
  if (input[i] != secret[i]) 
     return false; // Fast Exit
}
        </div>

        <div class="viz-box">
            <div style="margin-bottom:10px;">Attacker Guessing: <span id="guess-display" style="color:var(--danger)">....</span></div>
            <div class="timing-bar-container">
                <div class="timing-label">
                    <span>Execution Time (Cycles)</span>
                    <span id="time-val">0</span>
                </div>
                <div class="timing-bar" id="time-bar"></div>
            </div>
            <div id="timing-log" style="margin-top:20px; font-size:0.8rem; color:#888;"></div>
        </div>

        <div style="display:flex; flex-wrap: wrap;">
            <button onclick="runTimingAttack()">Run Attack</button>
            <button onclick="toggleSecureCompare()" style="background:#444;" id="btn-timing-fix">Toggle Mitigation</button>
        </div>
    </div>

    <!-- LAB 2: SPECTRE -->
    <div class="lab-card">
        <div class="lab-header">
            <span class="lab-title">2. Spectre (Speculative Execution)</span>
        </div>
        <p style="font-size:0.9rem; color:#aaa;">CPU predicts branches. Wrong predictions still load secrets into Cache.</p>

        <div class="viz-box">
            <div class="cpu-pipeline">
                <div class="stage" id="stage-branch">Branch<br>Predictor</div>
                <div style="font-size:2rem;">&rarr;</div>
                <div class="stage" id="stage-exec">Speculative<br>Execution</div>
                <div style="font-size:2rem;">&rarr;</div>
                <div class="stage" id="stage-cache">L1 Cache<br>(Side Effect)</div>
            </div>
            <div style="text-align:center; margin-top:20px; font-size:0.9rem;" id="spectre-status">Status: Idle</div>
        </div>

        <div style="display:flex; flex-wrap: wrap;">
            <button onclick="runSpectre()">Simulate Spectre</button>
            <button onclick="mitigateSpectre()" style="background:#444;" id="btn-spectre-fix">Insert LFENCE (Fix)</button>
        </div>
    </div>

    <!-- LAB 3: SECURE ELEMENT -->
    <div class="lab-card">
        <div class="lab-header">
            <span class="lab-title">3. Secure Element (SE)</span>
        </div>
        <p style="font-size:0.9rem; color:#aaa;">Main CPU vs. Isolated SE. Can you extract the key if the OS is rooted?</p>

        <div class="viz-box">
            <div class="se-layout">
                <div class="chip chip-cpu" id="chip-main">
                    <div>Main CPU</div>
                    <div style="font-size:0.7rem; color:var(--danger)">(Rooted/Compromised)</div>
                    <div id="msg-cpu" class="msg-bubble">Request...</div>
                </div>
                <div class="data-path"></div>
                <div class="chip chip-se">
                    <div class="lock-icon">ðŸ”’</div>
                    <div>Secure Element</div>
                    <div style="font-size:0.7rem; color:var(--success)">Key: 0x9F3A...</div>
                    <div id="msg-se" class="msg-bubble">Result</div>
                </div>
            </div>
            <div id="se-log" style="position:absolute; bottom:5px; left:10px; font-size:0.8rem; color:#aaa;"></div>
        </div>

        <div style="display:flex; flex-wrap: wrap;">
            <button class="btn-danger" onclick="runSEAttack()">Attack: Read Key Memory</button>
            <button class="btn-success" onclick="useSELegit()">Legit: Sign(Hash)</button>
        </div>
    </div>

    <!-- LAB 4: FIRMWARE & DRIVERS -->
    <div class="lab-card">
        <div class="lab-header">
            <span class="lab-title">4. Firmware/DMA Attack</span>
        </div>
        <p style="font-size:0.9rem; color:#aaa;">Malicious Peripheral (Driver/Firmware) accessing RAM. IOMMU defends this.</p>

        <div class="viz-box">
            <div class="dma-layout">
                <div class="peripheral">
                    <div>
                        <strong>Malicious NIC</strong><br>
                        (Compromised Firmware)
                    </div>
                </div>
                <div class="ram-block">
                    <div class="iommu-gate" id="iommu-gate"></div>
                    <div>
                        <strong>System RAM</strong><br>
                        Kernel Memory<br>
                        (Passwords)
                    </div>
                    <div id="dma-status" style="position:absolute; bottom:5px; font-size:0.8rem;"></div>
                </div>
            </div>
        </div>

        <div style="display:flex; flex-wrap: wrap;">
            <button class="btn-danger" onclick="runDMAAttack()">Attack: DMA Read</button>
            <button onclick="toggleIOMMU()" style="background:#444;" id="btn-iommu">Enable IOMMU</button>
        </div>
    </div>

</div>

<script>
    // --- LAB 1: TIMING ATTACK LOGIC ---
    let isSecureTiming = false;
    const SECRET = "PASS";
    
    function toggleSecureCompare() {
        isSecureTiming = !isSecureTiming;
        const codeBlock = document.getElementById('timing-code');
        const btn = document.getElementById('btn-timing-fix');
        
        if (isSecureTiming) {
            codeBlock.innerHTML = `// Secure: Constant Time
int result = 0;
for (i=0; i < len; i++) {
  result |= (input[i] ^ secret[i]);
}
return result == 0;`;
            codeBlock.style.borderColor = "var(--success)";
            btn.innerText = "Disable Mitigation";
            btn.style.background = "var(--success)";
        } else {
            codeBlock.innerHTML = `// Insecure: Fast Fail
for (i=0; i < len; i++) {
  if (input[i] != secret[i]) 
     return false; // Fast Exit
}
            `;
            codeBlock.style.borderColor = "var(--accent)";
            btn.innerText = "Toggle Mitigation";
            btn.style.background = "#444";
        }
    }

    async function runTimingAttack() {
        const chars = ['A', 'B', 'P', 'S', 'X']; 
        const display = document.getElementById('guess-display');
        const bar = document.getElementById('time-bar');
        const val = document.getElementById('time-val');
        const log = document.getElementById('timing-log');

        let currentGuess = "";
        log.innerHTML = "Starting Timing Analysis...";

        for (let i = 0; i < 4; i++) { 
            let maxTime = 0;
            let bestChar = '?';

            for (let char of chars) {
                display.innerText = currentGuess + char + "...";
                let time = 10; 
                
                if (isSecureTiming) {
                    time = 100; 
                } else {
                    if (char === SECRET[i]) {
                        time += 20 + (Math.random() * 2); 
                    } else {
                        time += 5; 
                    }
                    time += (i * 20); 
                }

                bar.style.width = (time) + '%';
                val.innerText = Math.floor(time);
                
                await new Promise(r => setTimeout(r, 100));

                if (time > maxTime) {
                    maxTime = time;
                    bestChar = char;
                }
            }

            if (isSecureTiming) {
                log.innerHTML = "FAIL: Constant time observed. Cannot deduce char.";
                bar.style.width = "100%";
                return;
            } else {
                currentGuess += bestChar;
                log.innerHTML += `<br>Char ${i+1} identified as '${bestChar}' via delay.`;
            }
        }
        display.innerText = currentGuess + " (CRACKED)";
        display.style.color = "var(--success)";
    }


    // --- LAB 2: SPECTRE LOGIC ---
    let spectreMitigated = false;

    function mitigateSpectre() {
        spectreMitigated = !spectreMitigated;
        const btn = document.getElementById('btn-spectre-fix');
        if(spectreMitigated) {
            btn.innerText = "Remove LFENCE";
            btn.style.background = "var(--success)";
        } else {
            btn.innerText = "Insert LFENCE (Fix)";
            btn.style.background = "#444";
        }
    }

    async function runSpectre() {
        const bPred = document.getElementById('stage-branch');
        const exec = document.getElementById('stage-exec');
        const cache = document.getElementById('stage-cache');
        const status = document.getElementById('spectre-status');

        bPred.className = 'stage'; exec.className = 'stage'; cache.className = 'stage';
        
        status.innerText = "1. Training Predictor (Valid Pattern)...";
        bPred.classList.add('active');
        await new Promise(r => setTimeout(r, 800));

        status.innerText = "2. Attacker requests Memory[OutOfBounds]...";
        await new Promise(r => setTimeout(r, 800));

        if (spectreMitigated) {
            status.innerHTML = "<span style='color:var(--success)'>LFENCE Barrier hit! Speculation stopped.</span>";
            return;
        }

        status.innerText = "3. Speculative Read executed...";
        exec.classList.add('active');
        exec.classList.add('secret'); 
        await new Promise(r => setTimeout(r, 800));

        status.innerText = "4. Secret moved to L1 Cache...";
        exec.classList.remove('active');
        cache.classList.add('active');
        cache.classList.add('secret');
        await new Promise(r => setTimeout(r, 800));

        status.innerHTML = "5. CPU Revert. <span style='color:var(--danger)'>Secret persists in Cache!</span>";
        bPred.className = 'stage'; 
        exec.className = 'stage';
    }

    // --- LAB 3: SECURE ELEMENT LOGIC ---
    function flashMsg(elementId, text, color) {
        const el = document.getElementById(elementId);
        el.innerText = text;
        el.style.opacity = 1;
        el.style.color = color;
        setTimeout(() => el.style.opacity = 0, 1500);
    }

    function runSEAttack() {
        const log = document.getElementById('se-log');
        flashMsg('msg-cpu', "READ 0xFF00", "red");
        
        setTimeout(() => {
            flashMsg('msg-se', "ACCESS DENIED", "red");
            log.innerHTML = "<span style='color:var(--success)'>Protection Success:</span> The OS cannot address SE memory directly. Hardware firewall engaged.";
        }, 600);
    }

    function useSELegit() {
        const log = document.getElementById('se-log');
        flashMsg('msg-cpu', "CMD: Sign(Hash)", "black");

        setTimeout(() => {
            flashMsg('msg-se', "Signed: 0xA1B2...", "green");
            log.innerHTML = "<span style='color:var(--text)'>Operation Success:</span> The Key was used internally. Only the result left the chip.";
        }, 600);
    }

    // --- LAB 4: FIRMWARE/DMA LOGIC ---
    let iommuEnabled = false;

    function toggleIOMMU() {
        iommuEnabled = !iommuEnabled;
        const gate = document.getElementById('iommu-gate');
        const btn = document.getElementById('btn-iommu');

        if(iommuEnabled) {
            gate.classList.add('active');
            btn.innerText = "Disable IOMMU";
            btn.style.background = "var(--success)";
        } else {
            gate.classList.remove('active');
            btn.innerText = "Enable IOMMU";
            btn.style.background = "#444";
        }
    }

    function runDMAAttack() {
        const status = document.getElementById('dma-status');
        status.innerHTML = "Initiating DMA Request...";
        status.style.color = "#aaa";

        setTimeout(() => {
            if(iommuEnabled) {
                status.innerHTML = "BLOCKED by IOMMU. <br>Peripheral mapped to empty virtual address.";
                status.style.color = "var(--success)";
            } else {
                status.innerHTML = "SUCCESS. <br>Malicious Firmware dumped Kernel RAM.";
                status.style.color = "var(--danger)";
            }
        }, 800);
    }

</script>

</body>
</html>