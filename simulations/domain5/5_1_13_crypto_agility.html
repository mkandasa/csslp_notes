<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSSLP Domain 5: Cryptography Lab</title>
    <style>
        :root {
            --bg-dark: #0f172a;
            --panel-bg: #1e293b;
            --crypto-green: #10b981;
            --legacy-red: #ef4444;
            --warn-yellow: #eab308;
            --migrated-blue: #3b82f6;
            --text: #f1f5f9;
            --border: #334155;
        }
        body {
            font-family: 'Segoe UI', monospace;
            background-color: var(--bg-dark);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        header {
            background: #000;
            width: 100%;
            padding: 15px 0;
            text-align: center;
            border-bottom: 3px solid var(--crypto-green);
            margin-bottom: 20px;
        }
        h1 { margin: 0; font-size: 1.5rem; color: var(--crypto-green); }

        .dashboard {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            width: 95%;
            max-width: 1400px;
            height: 700px;
        }

        /* CONTROLS */
        .controls {
            background: var(--panel-bg);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #334155;
            overflow-y: auto;
            max-height: 650px;
        }
        
        .section-title {
            color: #94a3b8;
            font-size: 0.8rem;
            text-transform: uppercase;
            border-bottom: 1px solid #475569;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }

        /* Algorithm Selector */
        .algo-display {
            background: #000;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
        }
        .algo-tag {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .algo-md5 { color: var(--legacy-red); }
        .algo-argon { color: var(--crypto-green); }

        /* Actions */
        button {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            transition: 0.2s;
        }
        .btn-audit { background: var(--warn-yellow); color: black; }
        .btn-upgrade { background: var(--migrated-blue); }
        .btn-crack { background: var(--legacy-red); }
        .btn-transport { background: #8b5cf6; }
        .btn-field { background: #ec4899; }
        
        button:hover { filter: brightness(1.1); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Login Form Sim */
        .login-box {
            border-top: 1px solid #444;
            padding-top: 20px;
            margin-top: 20px;
        }
        input {
            width: 100%;
            padding: 10px;
            background: #0f172a;
            border: 1px solid #475569;
            color: white;
            border-radius: 4px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        .btn-login { background: var(--crypto-green); color: black; }

        /* VISUALIZATION */
        .viz-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Database View */
        .db-container {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 15px;
            flex-grow: 1;
            max-height: 400px;
            overflow-y: auto;
        }
        table { width: 100%; border-collapse: collapse; font-family: monospace; font-size: 0.85rem; }
        th { text-align: left; color: #94a3b8; border-bottom: 1px solid #475569; padding: 5px; }
        td { padding: 8px 5px; border-bottom: 1px solid #333; word-break: break-all; }
        
        .hash-weak { color: var(--legacy-red); }
        .hash-strong { color: var(--crypto-green); }
        .version-badge { font-size: 0.7rem; padding: 2px 5px; border-radius: 3px; background: #333; }
        .enc-field { color: #ec4899; }

        /* LOGS */
        .console {
            background: #000;
            height: 150px;
            border: 1px solid #334155;
            padding: 10px;
            font-family: monospace;
            font-size: 0.85rem;
            color: #aaa;
            overflow-y: auto;
        }
        .log-sys { color: var(--crypto-green); }
        .log-err { color: var(--legacy-red); }
        .log-mig { color: var(--migrated-blue); }
        .log-net { color: #8b5cf6; }

        /* Rainbow Table Overlay */
        .crack-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .crack-box {
            background: #111;
            border: 2px solid var(--legacy-red);
            padding: 20px;
            width: 400px;
            text-align: center;
            border-radius: 8px;
        }
        .crack-prog {
            width: 100%; height: 10px; background: #333;
            margin: 15px 0; border-radius: 5px; overflow: hidden;
        }
        .crack-fill { height: 100%; width: 0%; background: var(--legacy-red); transition: width 2s linear; }

    </style>
</head>
<body>

<header>
    <h1>Crypto Agility & Migration Lab</h1>
    <p>Upgrading from Weak (MD5) to Strong (Argon2) Hashing & Layered Encryption</p>
</header>

<div class="dashboard">

    <!-- CONTROLS -->
    <div class="controls">
        <div class="section-title">1. Current Policy</div>
        <div class="algo-display">
            Target Algorithm:
            <div id="policy-display" class="algo-tag algo-md5">MD5 (Legacy)</div>
        </div>
        <button class="btn-upgrade" onclick="upgradePolicy()">üõ°Ô∏è Update Policy to Argon2</button>

        <div class="section-title" style="margin-top:20px;">2. Vulnerability Check</div>
        <button class="btn-audit" onclick="runAudit()">üîç Audit Database</button>
        <button class="btn-crack" onclick="runCrack()">üî® Simulate Rainbow Table Attack</button>

        <div class="section-title" style="margin-top:20px;">3. Layered Protection</div>
        <button class="btn-transport" onclick="simTransport()">üì° Simulate Transport (TLS)</button>
        <button class="btn-field" onclick="simFieldEnc()">üîê Simulate Field Encryption</button>

        <div class="section-title" style="margin-top:20px;">4. User Interaction</div>
        <div class="login-box">
            <label>Simulate User Login:</label>
            <select id="user-select">
                <option value="1">Alice (Regular User)</option>
                <option value="2">Bob (Admin)</option>
                <option value="3">Charlie (New User)</option>
            </select>
            <button class="btn-login" onclick="simLogin()">Log In</button>
            <div style="font-size:0.75rem; color:#aaa; margin-top:5px;">
                *Logging in triggers automatic re-hashing if policy is upgraded.
            </div>
        </div>
    </div>

    <!-- VISUALIZATION -->
    <div class="viz-area">
        
        <div class="db-container">
            <h3 style="margin-top:0; color:#aaa; font-size:0.9rem;">User Credentials Database</h3>
            <table id="db-table">
                <thead>
                    <tr><th>ID</th><th>User</th><th>Ver</th><th>Stored Hash</th><th>SSN (Field Enc)</th></tr>
                </thead>
                <tbody id="db-rows">
                    <!-- Rows -->
                </tbody>
            </table>
        </div>

        <!-- LOGS -->
        <div class="console" id="logger">
            <div>> Crypto Module Loaded. Default: MD5.</div>
        </div>

    </div>

</div>

<!-- OVERLAYS -->
<div class="crack-overlay" id="crack-modal">
    <div class="crack-box">
        <h2 style="color:var(--legacy-red)">Rainbow Table Attack</h2>
        <p>Checking MD5 hashes against 10M dictionary...</p>
        <div class="crack-prog"><div class="crack-fill" id="crack-bar"></div></div>
        <div id="crack-result" style="font-family:monospace;">Scanning...</div>
        <button onclick="closeCrack()" style="background:#333; margin-top:10px;">Close</button>
    </div>
</div>

<script>
    // Initial Data: Weak MD5 Hashes
    let users = [
        { id: 1, name: "Alice", algo: "MD5", hash: "5f4dcc3b5aa765d61d8327deb882cf99", plain: "password", ssn: "123-45-6789" },
        { id: 2, name: "Bob", algo: "MD5", hash: "21232f297a57a5a743894a0e4a801fc3", plain: "admin", ssn: "987-65-4321" },
        { id: 3, name: "Charlie", algo: "MD5", hash: "098f6bcd4621d373cade4e832627b4f6", plain: "test", ssn: "111-22-3333" }
    ];

    let currentPolicy = "MD5";
    let fieldEncEnabled = false;

    function init() {
        renderDB();
    }

    function log(msg, type) {
        const box = document.getElementById('logger');
        const div = document.createElement('div');
        const time = new Date().toLocaleTimeString().split(' ')[0];
        div.innerHTML = `<span style="color:#555">[${time}]</span> <span class="${type==='ok'?'log-ok':(type==='err'?'log-err':(type==='mig'?'log-mig':(type==='net'?'log-net':'log-sys')))}">${msg}</span>`;
        box.prepend(div);
    }

    function renderDB() {
        const tbody = document.getElementById('db-rows');
        tbody.innerHTML = "";
        
        users.forEach(u => {
            const row = document.createElement('tr');
            const hashClass = u.algo === 'MD5' ? 'hash-weak' : 'hash-strong';
            const verClass = u.algo === 'MD5' ? 'background:#3e0a0a; color:#ef4444' : 'background:#064e3b; color:#22c55e';
            
            // Field Enc Simulation
            let displaySSN = u.ssn;
            if (fieldEncEnabled && !displaySSN.startsWith("ENC:")) {
                // If enabled, simulate encryption view
                displaySSN = "ENC:" + btoa(u.ssn).substring(0, 10) + "..."; 
            } else if (!fieldEncEnabled && displaySSN.startsWith("ENC:")) {
                 // Decrypt
                 displaySSN = u.ssn.replace("ENC:", ""); // Simplified restoration
            }

            row.innerHTML = `
                <td>${u.id}</td>
                <td>${u.name}</td>
                <td><span class="version-badge" style="${verClass}">${u.algo}</span></td>
                <td class="${hashClass}">${u.hash.substring(0, 20)}...</td>
                <td class="${fieldEncEnabled ? 'enc-field' : ''}">${displaySSN}</td>
            `;
            tbody.appendChild(row);
        });
    }

    function runAudit() {
        log("AUDIT: Scanning stored credentials...", "sys");
        const weakCount = users.filter(u => u.algo === 'MD5').length;
        
        setTimeout(() => {
            if (weakCount > 0) {
                log(`FAIL: Found ${weakCount} legacy MD5 hashes. Vulnerable to collisions/cracking.`, "err");
            } else {
                log("PASS: All hashes migrated to Argon2 (Salted).", "ok");
            }
        }, 500);
    }

    function runCrack() {
        const weakCount = users.filter(u => u.algo === 'MD5').length;
        if (weakCount === 0) {
            log("ATTACK: Rainbow Table failed. Argon2 is resistant.", "ok");
            return;
        }

        document.getElementById('crack-modal').style.display = 'flex';
        const bar = document.getElementById('crack-bar');
        const res = document.getElementById('crack-result');
        
        // Animate
        setTimeout(() => bar.style.width = "100%", 10);
        
        setTimeout(() => {
            res.innerHTML = `
                CRACKED: Alice -> "password"<br>
                CRACKED: Bob -> "admin"<br>
                CRACKED: Charlie -> "test"
            `;
            res.style.color = "var(--legacy-red)";
            log("ATTACK: Legacy hashes cracked in 2.0 seconds.", "err");
        }, 2000);
    }

    function closeCrack() {
        document.getElementById('crack-modal').style.display = 'none';
        document.getElementById('crack-bar').style.width = "0%";
        document.getElementById('crack-result').innerText = "Scanning...";
    }

    function upgradePolicy() {
        currentPolicy = "Argon2";
        const disp = document.getElementById('policy-display');
        disp.innerText = "Argon2 (Modern)";
        disp.className = "algo-tag algo-argon";
        log("CONFIG: App configured to generate new hashes with Argon2id.", "sys");
        log("NOTE: Existing DB rows remain MD5 until user login (Lazy Migration).", "mig");
    }

    function simTransport() {
        log("NETWORK: Intercepting traffic...", "net");
        setTimeout(() => {
            // Randomly choose HTTPS vs HTTP for demo
            log("PACKET CAPTURE: POST /login HTTP/1.1", "net");
            log("HEADER: Host: secure-bank.com", "net");
            log("BODY (TLS 1.3): [Encrypted Data Blob - Unreadable]", "ok");
            log("INFO: Transport Layer Security prevented credential sniffing.", "ok");
        }, 800);
    }

    function simFieldEnc() {
        fieldEncEnabled = !fieldEncEnabled;
        if (fieldEncEnabled) {
            log("CONFIG: Field Level Encryption (AES-GCM) Enabled for SSN column.", "mig");
            // Update data model
            users.forEach(u => {
                if (!u.ssn.startsWith("ENC:")) u.ssn = "ENC:" + btoa(u.ssn); 
            });
        } else {
            log("CONFIG: Field Level Encryption Disabled. Data stored in plaintext.", "err");
             users.forEach(u => {
                if (u.ssn.startsWith("ENC:")) u.ssn = atob(u.ssn.split(":")[1]); 
            });
        }
        renderDB();
    }

    function simLogin() {
        const id = parseInt(document.getElementById('user-select').value);
        const user = users.find(u => u.id === id);

        log(`LOGIN: User '${user.name}' authenticating...`, "sys");

        // Simulate Verify
        setTimeout(() => {
            log("AUTH: Password Verified.", "ok");

            // Migration Logic
            if (currentPolicy === "Argon2" && user.algo === "MD5") {
                log(`MIGRATE: Upgrading hash for '${user.name}' from MD5 to Argon2...`, "mig");
                
                // Simulate new hash
                user.algo = "Argon2";
                user.hash = "$argon2id$v=19$m=65536,t=3,p=4$" + Math.random().toString(36).substring(7);
                
                renderDB();
                log("DB: Record updated transparently.", "ok");
            }
        }, 600);
    }

    // Start
    init();

</script>

</body>
</html>